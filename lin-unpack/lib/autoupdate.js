"use strict";function e(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,r){var n,t;for(n=0;n<r.length;n++)t=r[n],t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}return function(r,n,t){return n&&e(r.prototype,n),t&&e(r,t),r}}(),n=require("fs"),t=require("path"),o=require("os"),i=require("request"),l=require("sudo-prompt"),s=require("express"),u=require("crypto"),a=t.join(o.tmpdir(),"vrlserviceSetup"),d=function(){function t(r,n,o){e(this,t),this.log=r,this.request=n,this.flpVersion=o,this._downloadUrl=this.flpVersion.directDownload[process.platform].url,this._expectedSha1=this.flpVersion.directDownload[process.platform].sha1,this._installer=null}return r(t,[{key:"downloadAndCheck",value:function(e){var r=this;this._download(function(n){return null!=n?void e(n):u.createHash("sha1").update(r._installer).digest("hex")!==r._expectedSha1?void e(Error("check sum failure")):void e()})}},{key:"_download",value:function(e){var r=this;this.request(this._downloadUrl,{encoding:null},function(n,t,o){return null!=n?void e(n):200!==t.statusCode?(r.log.system.info({res:t,body:o},"download returned unexpected status"),void e(Error("status not 200"))):(r._installer=o,void e(null))})}},{key:"install",value:function(e){var r=this;this._saveInTemp(function(n){return n?void e(n):void r._install(e)})}},{key:"_saveInTemp",value:function(e){return null==this._installer?void e(Error("no download available")):void n.writeFile(a,this._installer,{mode:493,encoding:null},e)}},{key:"_install",value:function(e){this.log.system.info({path:a},"starting setup for update"),l.exec(a,{name:"VRay License Server",detached:!0},function(r){return r?void e(r):void e(null)})}}]),t}();exports.AutoupdateService=function(){function n(r,t){e(this,n),this.log=r||require("ols-logger").FLP;var o=t.getProxy();this.request=i.defaults({proxy:o,tunnel:!!o})}return r(n,[{key:"_notifyForUpdate",value:function(e){this.notifications={flpVersionDownloaded:e}}},{key:"onUserApproved",value:function(){var e,r=this;if(null!=this.currentUpdate)return e=this.currentUpdate,e.notified?void e.install(function(n){n&&(r.log.system.error("error installing update",n),setTimeout(function(){return e.onUserApproved()},9e5)),r.log.system.info("installation complete")}):void this.log.system.warn("newer version is being downloaded")}},{key:"downloadImmediately",value:function(){var e,r=this;null!=this.currentUpdate&&(e=this.currentUpdate,e.downloadAndCheck(function(n){return n?(r.log.system.error("error downloading update",n),void setTimeout(function(){return r.onUserApproved()},9e5)):e!==r.currentUpdate?void r.log.system.warn("newer version is being downloaded"):(r._notifyForUpdate(e.flpVersion),void(e.notified=!0))}))}},{key:"checkForNewVersion",value:function(e){null!=e&&null!=e.flpVersion&&null!=e.flpVersion.versionStr&&null!=e.flpVersion.directDownload&&null!=e.flpVersion.directDownload[process.platform]&&null!=e.flpVersion.directDownload[process.platform].url&&null!=e.flpVersion.directDownload[process.platform].sha1&&(null!=this.currentUpdate&&e.flpVersion.versionStr===this.currentUpdate.flpVersion.versionStr||(this.currentUpdate=new d(this.log,this.request,e.flpVersion),this.downloadImmediately()))}}]),n}(),exports.createUpdateRoute=function(e){var r=new s.Router;return r.use(function(r,n){return r.local?(e.onUserApproved(),void n.redirect("/")):void n.status(403).end()}),r},exports.singleton=new exports.AutoupdateService(require("ols-logger").FLP,require("../config"));