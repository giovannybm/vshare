"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var e=function(){function t(t,e){var i,n;for(i=0;i<e.length;i++)n=e[i],n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),i=require("ols-logger").FLP,n=require("./transforms"),a=require("./online/authentication-manager"),r=require("../lib/autoupdate"),s=2592e6,o=function(){function o(e,i){t(this,o),this.state={enabled:!1,available:!1,activating:!1},this.configure(e,i)}return e(o,[{key:"start",value:function(){i.system.debug("Starting online subsystem monitoring."),this.auth.start(this.getState.bind(this,null))}},{key:"configure",value:function(t,e){this.auth&&this.auth.removeAllListeners("activated").removeAllListeners("deactivated"),this.config=t,this.workstation=e,this.auth=new a(t,e),this.auth.on("activated",this.getState.bind(this)),this.auth.on("deactivated",this.getState.bind(this))}},{key:"getState",value:function(t){var e=this;this.auth.ok?(i.user.trace("Loading user info from BLP."),this.auth.request("userInfo",{qs:{flpVersion:this.workstation.version}},function(n,a,o){var u,l,c,d,f,h,y,p;if(e.state={enabled:e.auth.ok,activating:e.auth.inProgress,available:!!e.auth.connection.blpUrl},!n&&200==a.statusCode&&o){u=JSON.parse(o),e.state.user=u,l=!0,c=!1,d=void 0;try{for(f=u.sites[Symbol.iterator]();!(l=(h=f.next()).done);l=!0)y=h.value,y.certificate.raw==e.workstation.cert&&(e.state.site=y),delete y.certificate.raw}catch(n){c=!0,d=n}finally{try{!l&&f["return"]&&f["return"]()}finally{if(c)throw d}}e.state.licenses=u.licenses,e.state.notifications=u.notifications||{},p=e.getExpiringLicenses(Date.now()+s),null!=p&&p.length>0&&(e.state.notifications.expiringOnline={expiration:p}),r.singleton.checkForNewVersion(e.state.notifications),delete u.licenses,delete u.notifications,i.user.trace(u,"Obtained user info from BLP.")}t&&t(null,e.state)})):(this.state={enabled:!1,activating:this.auth.inProgress,available:!!this.auth.connection.blpUrl},t&&t(null,this.state))}},{key:"canHandleRequest",value:function(){return this.auth.ok}},{key:"handleRequest",value:function(t,e){i.user.trace("Online subsystem handling license request."),this.auth.request(t.url,{headers:t.headers},function(t,n,a){return t?(i.user.error({err:t},"Online subsystem failed to handle license request."),e(500,t.message)):(i.user.trace({res:n},"Online subsystem handled license request."),e(n.statusCode,a,n.headers["x-tag"],n.headers["x-session-operation"]))})}},{key:"getTotal",value:function(t){var e,i,a,r,s,o,u,l,c,d,f,h,y={};if(this.state&&this.state.enabled&&this.state.available){e=!0,i=!1,a=void 0;try{for(r=n.toUnique(t,this.state.licenses)[Symbol.iterator]();!(e=(s=r.next()).done);e=!0){o=s.value,y[o]={1:0,2:0,4:0},u=!0,l=!1,c=void 0;try{for(d=this.state.licenses[Symbol.iterator]();!(u=(f=d.next()).done);u=!0)h=f.value,o==h.product.productId&&n.addAmounts(y[o],h.product)}catch(p){l=!0,c=p}finally{try{!u&&d["return"]&&d["return"]()}finally{if(l)throw c}}this.state.site.offline&&this.state.site.offline.products[o]&&n.subtractAmounts(y[o],this.state.site.offline.products[o])}}catch(p){i=!0,a=p}finally{try{!e&&r["return"]&&r["return"]()}finally{if(i)throw a}}}return y}},{key:"getTotalDetails",value:function(t){return this.state.enabled&&this.state.available?this.state.licenses.filter(function(e){return e.product.productId==t}).map(function(t){var e=Object.assign({},t.product);return delete e.productId,delete e.productLabel,delete e.defaultLicenseType,e.expiryDate=t.expiryDate,e}).sort(function(t,e){return t.expiryDate<e.expiryDate}):[]}},{key:"getEngaged",value:function(t){var e,i,a,r,s,o,u,l,c,d,f,h,y={};if(this.state.enabled&&this.state.available){e=!0,i=!1,a=void 0;try{for(r=n.toUnique(t,this.state.licenses)[Symbol.iterator]();!(e=(s=r.next()).done);e=!0){o=s.value,y[o]={1:0,2:0,4:0},u=!0,l=!1,c=void 0;try{for(d=this.state.user.sites[Symbol.iterator]();!(u=(f=d.next()).done);u=!0)h=f.value,h.online&&h.online.products[o]&&n.addAmounts(y[o],h.online.products[o]),h.id!=this.state.site.id&&h.offline&&h.offline.products[o]&&n.addAmounts(y[o],h.offline.products[o])}catch(p){l=!0,c=p}finally{try{!u&&d["return"]&&d["return"]()}finally{if(l)throw c}}}}catch(p){i=!0,a=p}finally{try{!e&&r["return"]&&r["return"]()}finally{if(i)throw a}}}return y}},{key:"getEngagedDetails",value:function(t,e){var i=this;this.state.enabled&&this.state.available?this.auth.request("sessions/"+t,{},function(a,r,s){var o,u,l,c,d,f,h,y;if(a||200!=r.statusCode)e(a||Error("Failed to load session data."));else{o=JSON.parse(s).map(function(t){var e,a=Object.assign({},t.product);return delete a.productId,delete a.productLabel,delete a.defaultLicenseType,a.details={ip:n.numberToIp(t.ipAddress),lastActive:Math.round(t.lastAccess/1e3),hostname:t.hostname},e=i.state.user.sites.find(function(e){return e.id==t.siteId}),e&&(a.details.location=e.name),a.mode="session",a}),u=!0,l=!1,c=void 0;try{for(d=i.state.user.sites[Symbol.iterator]();!(u=(f=d.next()).done);u=!0)h=f.value,h.id!=i.state.site.id&&h.offline&&h.offline.products[t]&&(y=Object.assign({},h.offline.products[t]),delete y.productId,delete y.productLabel,delete y.defaultLicenseType,y.details={location:h.name,expires:h.offline.expiryDate},y.mode="borrowed",o.push(y))}catch(a){l=!0,c=a}finally{try{!u&&d["return"]&&d["return"]()}finally{if(l)throw c}}e(null,o)}}):setImmediate(e,null,[])}},{key:"getProductLabels",value:function(t){var e,i,a,r,s,o,u=this,l={};if(this.state.enabled&&this.state.available){e=!0,i=!1,a=void 0;try{for(r=function(){var t=o.value,e=u.state.licenses.find(function(e){return e.product.productId==t});e&&(l[t]=e.product.productLabel)},s=n.toUnique(t,this.state.licenses)[Symbol.iterator]();!(e=(o=s.next()).done);e=!0)r()}catch(c){i=!0,a=c}finally{try{!e&&s["return"]&&s["return"]()}finally{if(i)throw a}}}return l}},{key:"getExpiringLicenses",value:function(t){return this.state.licenses.filter(function(e){return e.expiryDate&&e.expiryDate<t}).map(function(t){return{productLabel:t.product.productLabel,expiryDate:t.expiryDate}}).sort(function(t,e){return t.expiryDate<e.expiryDate})}}]),o}();module.exports=o;